-- Tworzenie tabel dla Lighter Broadcaster
-- Wklej w Supabase SQL Editor

-- Account snapshots table
CREATE TABLE IF NOT EXISTS account_snapshots (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    account_index INTEGER NOT NULL,
    exchange VARCHAR(50) NOT NULL DEFAULT 'lighter',
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    equity DECIMAL,
    margin DECIMAL,
    available_balance DECIMAL,
    pnl DECIMAL,
    positions_count INTEGER DEFAULT 0,
    orders_count INTEGER DEFAULT 0,
    raw_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_account_snapshots_account ON account_snapshots(account_index);
CREATE INDEX IF NOT EXISTS idx_account_snapshots_exchange ON account_snapshots(exchange);
CREATE INDEX IF NOT EXISTS idx_account_snapshots_timestamp ON account_snapshots(timestamp DESC);

-- Positions table
CREATE TABLE IF NOT EXISTS positions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    account_index INTEGER NOT NULL,
    exchange VARCHAR(50) NOT NULL DEFAULT 'lighter',
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    market VARCHAR(50),
    side VARCHAR(10),
    size DECIMAL,
    entry_price DECIMAL,
    mark_price DECIMAL,
    unrealized_pnl DECIMAL,
    raw_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_positions_account ON positions(account_index);
CREATE INDEX IF NOT EXISTS idx_positions_exchange ON positions(exchange);
CREATE INDEX IF NOT EXISTS idx_positions_timestamp ON positions(timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_positions_market ON positions(market);

-- Orders table
CREATE TABLE IF NOT EXISTS orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    account_index INTEGER NOT NULL,
    exchange VARCHAR(50) NOT NULL DEFAULT 'lighter',
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    order_id VARCHAR(100),
    market VARCHAR(50),
    side VARCHAR(10),
    order_type VARCHAR(20),
    price DECIMAL,
    size DECIMAL,
    filled DECIMAL,
    status VARCHAR(20),
    raw_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_orders_account ON orders(account_index);
CREATE INDEX IF NOT EXISTS idx_orders_exchange ON orders(exchange);
CREATE INDEX IF NOT EXISTS idx_orders_timestamp ON orders(timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_orders_order_id ON orders(order_id);
CREATE INDEX IF NOT EXISTS idx_orders_market ON orders(market);

-- Trades table
CREATE TABLE IF NOT EXISTS trades (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    account_index INTEGER NOT NULL,
    exchange VARCHAR(50) NOT NULL DEFAULT 'lighter',
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    trade_id VARCHAR(100),
    market VARCHAR(50),
    side VARCHAR(10),
    price DECIMAL,
    size DECIMAL,
    fee DECIMAL,
    raw_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_trades_account ON trades(account_index);
CREATE INDEX IF NOT EXISTS idx_trades_exchange ON trades(exchange);
CREATE INDEX IF NOT EXISTS idx_trades_timestamp ON trades(timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_trades_trade_id ON trades(trade_id);
CREATE INDEX IF NOT EXISTS idx_trades_market ON trades(market);